sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: IgRKgfn4o8/tvbhuu4VZRT3LcM8qi/IYfmq+/kx7PMtc3dS1SAI23EPRu1l03Xz6n/0i0a5ok9ijYkeD28cunxLu0ZPEeJIAItwtZL1k09JK0z8lRvKxJzkFvASCLG8V6hiY7fZLW4vKCkISHiTdR8xLERwnStQ8/oghjQx8OuiQlFknGWbSgs4QJZumdptmJCxuFuPseKr8edV7Rv4UV6YAGvZ9un4r5/fosnRf7W99OyjL/jDHlNM92Hggjovyhzejkg2ebSPPp6Z6AVb9GhkWeebwwYzc+tqi03FsxmRlu7434l6StYPaLqNJaQQfZNSUKg23RRdVoiJGu5+q3teaXObADbKF5ebP5X73Rso21ROErwU7QGLsaL7e4GKNzGVORzYvoRJrrjCAGMZgPMI+28qp49Wtnuy421rj7kBITpFpLIbHshSTISecd1aYvZ0H2VjJXRdwZuTH3+7FuAQR/0/gzTi8t4Ssz95eTaZNtnM0TpDLh464WFAewxGT2Nw3k/0Jq6NubjpbwNZ+zaEvuBRPNm3bmklaoswBQPUwuKygp1owy9zYniD2byfgrcvFLzQ6A80TBAlnifGf1ID8azAUayv4jk0VRTjWZBZqcl3vxb0fhOL9/AX+kdwYKOO87bhTzYHhUF4fjcVfGCC125k5TpD+y6+y6YdshGM=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Okewood-of-the-Secret-Service_2417
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy